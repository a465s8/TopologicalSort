<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>课程编制系统</title>
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/jumbotron.css" rel="stylesheet">
</head>



<body id="body" class="svg-wrap">
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">


            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">课程编制系统</a>
        </div>

    </div>
</nav>

<!-- Main jumbotron for a primary marketing message or call to action -->
<div class="jumbotron" >
    <div class="container" >



        <textarea id="ta" style="width:400px;height:180px;resize: none" placeholder="请在此处输入课程顺序，例如<a,b>"></textarea>
        <br>
        <div>
            <div style="width:100px;;margin:0;float:left;"><input id="bt" value="确认" type="button"/></div>
            <div style="width:120px;padding:0;margin:0;float:left;"><input type='file' accept='text/plain' onchange='openFile(event)' value='导入文件'/></div>

            <div style="width:160px;padding:0;margin:0;float:left;"><button onclick="change()">change</button></div>
    </div>

    </div>
</div>

<div class="container">
    <!-- Example row of columns -->
    <div class="row" style="height: 200px">
        <div class="col-md-4">
            <div id="BeforeCanvas">
                <h3>课程关系图</h3>
            </div>
        </div>
        <div class="col-md-4">
            <div id="SortCanvas">
                <h3>课程安排图</h3>
            </div>
        </div>
        <div class="col-md-4">

        </div>
    </div>




</div> <!-- /container -->


<footer>
    <hr>
    <p>@The most handsome group of STU</p>
</footer>







</body>
<!-- <script src="./html2canvas.js"></script>
<script  src="./canvas2image.js"></script>
<script  src="./base64.js"></script> -->
<script src="./js/svgToPng.js"></script>
<script src="./js/index.js"></script>
<script src="./js/viz.js"></script>
<script src="./js/full.render.js"></script>
<script type="text/javascript">
    //js 读取txt文件
    function openFile(event) {
        var input = event.target;
        var reader = new FileReader();
        reader.onload = function() {
            if(reader.result) {
                //显示文件内容
                console.log(reader.result);
                document.getElementById("ta").value = reader.result;
            }
        };
        reader.readAsText(input.files[0]);
    };
    //确认按钮点击事件
    document.getElementById("bt").onclick = function(){
        //清空旧svg
        var body1 = document.getElementById("BeforeCanvas");
        var body2 = document.getElementById("SortCanvas")
        var svg = document.getElementById("svgBefore");
        var svgs=document.getElementById("svgSort");
        if(svg != null)
        {
            body1.removeChild(svg);
            body2.removeChild(svgs);
        }
        var text = document.getElementById("ta").value;
        var arr = text.split("\n");
        var map = new Map();//保存所有Vertix的集合
        var edges = new Array();//保存所有的Edge
        var graph = 'digraph graphname{'
        for(var i=0;i<arr.length;i++){
            var temp = arr[i].split(",");
            if(temp.length != 2){
                alert("输入错误，请重新检查");
                return;
            }
            var v0 = temp[0].trim().substring(1);
            var v1 = temp[1].trim().substring(0, temp[1].trim().length-1);
            var v00,v11;//两个Vertix对象
            if(map.get(v0) == null){
                v00 = new Vertex(v0);
                map.set(v0, v00);
            }else
                v00 = map.get(v0);
            if(map.get(v1) == null){
                v11 = new Vertex(v1);
                map.set(v1, v11);
            }else
                v11 = map.get(v1);
            var edge = new Edge(v00, v11);
            edges.push(edge);
            graph = graph + v0 + '->' + v1 +';';
        }
        //画出拓扑排序前的图
        graph += '}';
        var viz = new Viz();
        viz.renderSVGElement(graph)
            .then(function(element) {
                element.id = "svgBefore";
                document.getElementById("BeforeCanvas").appendChild(element);
            })
            .catch(error => {
                // Create a new Viz instance (@see Caveats page for more info)
                viz = new Viz();
                // Possibly display the error
                console.error(error);
            });
        //Vertex数组
        var vertexs = new Array();
        var mapIter  = map.values();
        var temp = mapIter.next().value;

        while(temp != null){
            vertexs.push(temp);
            temp = mapIter.next().value;
        }
        //图
        var g = new Graph(vertexs,edges);
        var result_tree = new ResultTree();
        g.topo_sort(g,t.root);
        console.log(g.sort_result);//打印排序后的结果


        //输出拓扑排序后的图
        viz = new Viz();
        var i=0;
        var sort_graph = 'digraph graphname{'
        if(g.sort_result.last_key!=-1){
            for (var key in g.sort_result) {
                if (g.sort_result.hasOwnProperty(key) && key!='last_key') {
                    var element = g.sort_result[key];
                    for( i=0;i<element.length;i++)
                    {
                        console.log('test'+i+element[i].name);

                        if(i+1<element.length)
                        {
                            sort_graph+=element[i].name+'->'+element[i+1].name+';';
                        }

                    }

                }
            }


            sort_graph+='}';
            console.log(sort_graph);
            viz.renderSVGElement(sort_graph)
                .then(function(element) {
                    element.id = "svgSort";
                    document.getElementById("SortCanvas").appendChild(element);
                })
                .catch(error => {
                    // Create a new Viz instance (@see Caveats page for more info)
                    viz = new Viz();
                    // Possibly display the error
                    console.error(error);
                });
        }

    }
</script>
<script type="text/javascript">
    function change(){
        var svgXml = $('#SortCanvas').html();
        var image = new Image();
        image.src = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(svgXml))); //给图片对象写入base64编码的svg流
        var canvas = document.createElement('canvas');  //准备空画布
        canvas.width = $('.svg-wrap svg').width();
        canvas.height = $('.svg-wrap svg').height();
        var context = canvas.getContext('2d');  //取得画布的2d绘图上下文
        context.drawImage(image, 0, 0);
        var a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');  //将画布内的信息导出为png图片数据
        a.download = "MapByMathArtSys";  //设定下载名称
        a.click(); //点击触发下载
    }
</script>
</html>